<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Rechnungsprogramm – Professionelle Version</title>

<!-- PDF ENGINE -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body {
    font-family: 'Arial';
    margin: 0;
    background: #eef0f4;
}
header {
    background: #1f2937;
    color: white;
    padding: 20px;
    text-align: center;
    font-size: 22px;
    letter-spacing: 1px;
}
.container {
    max-width: 950px;
    margin: auto;
    padding: 20px;
}
.box {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 22px;
    box-shadow: 0 0 15px rgba(0,0,0,0.08);
}
h2 {
    margin-top: 0;
    padding-left: 10px;
    border-left: 5px solid #1f2937;
}
input, textarea {
    width: 100%;
    padding: 10px;
    margin-bottom: 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    text-align: center;
    font-size: 15px;
}
button {
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-right: 10px;
    font-size: 15px;
}
.save { background: #16a34a; color: white; }
.clear { background: #dc2626; color: white; }
.print { background: #2563eb; color: white; }
.pdf { background: #7c3aed; color: white; }
.edit { background: #ea580c; color: white; }
.delete { background: #8b0000; color: white; }

/* Positionstabelle */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    border-radius: 10px;
    overflow: hidden;
}
th {
    background: #f3f4f6;
    padding: 10px;
}
td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    text-align: center;
}

/* PRINT LAYOUT */
@media print {
    header, .no-print { display: none !important; }
    body { background: white; }
    #pdfArea { padding: 20px; }
}
</style>
</head>
<body>

<header>Rechnungsprogramm – Professionelle Version</header>

<div class="container">

    <!-- FIRMENDATEN -->
    <div class="box no-print">
        <h2>Firmendaten</h2>
        <img src="Logo.png" style="width:120px; margin-bottom:10px;">
        <input id="firma" placeholder="Firmenname">
        <input id="adresse" placeholder="Adresse">
        <input id="email" placeholder="E-Mail">
        <input id="telefon" placeholder="Telefon">
        <button class="save" onclick="saveFirmendaten()">Speichern</button>
    </div>

    <!-- RECHNUNG -->
    <div class="box">
        <h2 class="no-print">Rechnung erstellen</h2>

        <div class="no-print">
            <input id="rnr" placeholder="Rechnungsnummer">
            <input id="kunde" placeholder="Kunde">
            <input id="datum" type="date">

            <h3>Positionen</h3>

            <table>
                <thead>
                    <tr>
                        <th>Beschreibung</th>
                        <th>Preis (€)</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody id="posBody"></tbody>
            </table>

            <button onclick="addPosition()">+ Position</button>

            <h3>Gesamtbetrag (€)</h3>
            <input id="summe">

            <button class="save" onclick="saveRechnung()">Speichern</button>
            <button class="clear" onclick="clearRechnung()">Leeren</button>
            <button class="print" onclick="printDirect()">Drucken</button>
            <button class="pdf" onclick="createPDF()">PDF speichern</button>
        </div>

        <!-- PDF/PRINT AREA -->
        <div id="pdfArea" style="display:none;">
            <img src="Logo.png" style="width:120px;"><br><br>

            <h1 style="text-align:center;">Rechnung</h1>

            <b>Rechnungsnummer:</b> <span id="p_rnr"></span><br>
            <b>Kunde:</b> <span id="p_kunde"></span><br>
            <b>Datum:</b> <span id="p_datum"></span><br><br>

            <b>Firma:</b> <span id="p_firma"></span><br>
            <b>Adresse:</b> <span id="p_adresse"></span><br>
            <b>Email:</b> <span id="p_email"></span><br>
            <b>Telefon:</b> <span id="p_telefon"></span><br><br>

            <table>
                <thead>
                    <tr><th>Beschreibung</th><th>Preis (€)</th></tr>
                </thead>
                <tbody id="p_pos"></tbody>
            </table>

            <h2 style="margin-top:20px;">Gesamt: <span id="p_summe"></span> €</h2>

            <p style="margin-top:20px; font-weight:bold;">
                Gemäß §19 UStG beinhaltet dieser Betrag keine Umsatzsteuer.
            </p>

            <br><br><br>
            <div style="margin-top:40px;">
                <b>Betrag erhalten – bestätigt durch Unterschrift:</b><br><br>
                <div style="border-bottom:2px solid #000; width:300px; height:40px;"></div>
            </div>
        </div>

    </div>

    <!-- ARCHIV -->
    <div class="box no-print">
        <h2>Archiv</h2>
        <div id="archivList"></div>
    </div>

</div>

<script>

/* ------- Firmendaten speichern/laden ------- */
function saveFirmendaten(){
    localStorage.setItem("firma", firma.value);
    localStorage.setItem("adresse", adresse.value);
    localStorage.setItem("email", email.value);
    localStorage.setItem("telefon", telefon.value);
    alert("Daten gespeichert!");
}
function loadFirmendaten(){
    firma.value = localStorage.getItem("firma") || "";
    adresse.value = localStorage.getItem("adresse") || "";
    email.value = localStorage.getItem("email") || "";
    telefon.value = localStorage.getItem("telefon") || "";
}
loadFirmendaten();

/* ------- Position hinzufügen ------- */
function addPosition(desc="", price="") {
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td><input class="p_desc" value="${desc}"></td>
        <td><input class="p_price" value="${price}"></td>
        <td><button onclick="this.parentElement.parentElement.remove()">X</button></td>
    `;
    posBody.appendChild(tr);
}

/* ------- Druck & PDF ------- */
function prepareDocument(r){
    p_rnr.innerText = r.rnr;
    p_kunde.innerText = r.kunde;
    p_datum.innerText = r.datum;

    p_firma.innerText = firma.value;
    p_adresse.innerText = adresse.value;
    p_email.innerText = email.value;
    p_telefon.innerText = telefon.value;

    p_summe.innerText = r.summe;

    p_pos.innerHTML = "";
    r.positionen.forEach(p=>{
        p_pos.innerHTML += `<tr><td>${p.desc}</td><td>${p.price}</td></tr>`;
    });

    pdfArea.style.display = "block";
}

function printDirect(){
    const r = collectCurrentRechnung();
    prepareDocument(r);
    window.print();
}

function createPDF(){
    const r = collectCurrentRechnung();
    prepareDocument(r);

    const opt = {
        margin: 10,
        filename: `Rechnung_${r.rnr}.pdf`,
        html2canvas: { scale:2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(pdfArea).save();
}

/* ------- Rechnung einsammeln ------- */
function collectCurrentRechnung(){
    let pos = [];
    document.querySelectorAll("#posBody tr").forEach(row => {
        pos.push({
            desc: row.querySelector(".p_desc").value,
            price: row.querySelector(".p_price").value
        });
    });

    return {
        rnr: rnr.value,
        kunde: kunde.value,
        datum: datum.value,
        summe: summe.value,
        positionen: pos
    };
}

/* ------- Speichern & Archiv ------- */
function saveRechnung(){
    let r = collectCurrentRechnung();

    let archiv = JSON.parse(localStorage.getItem("archiv")) || [];
    archiv.push(r);
    archiv.sort((a,b)=>Number(a.rnr)-Number(b.rnr));

    localStorage.setItem("archiv", JSON.stringify(archiv));
    loadArchiv();

    alert("Rechnung gespeichert!");
}

function loadArchiv(){
    let archiv = JSON.parse(localStorage.getItem("archiv")) || [];
    archivList.innerHTML = "";

    archiv.forEach(r=>{
        const div = document.createElement("div");
        div.style.padding = "10px 0";

        div.innerHTML = `
            <b>#${r.rnr}</b> – ${r.kunde} – ${r.summe} €<br>
            <button class="edit" onclick='editRechnung(${JSON.stringify(r)})'>Bearbeiten</button>
            <button class="print" onclick='previewArchiv(${JSON.stringify(r)})'>Drucken</button>
            <button class="delete" onclick='deleteRechnung(${r.rnr})'>Löschen</button>
        `;
        archivList.appendChild(div);
    });
}
loadArchiv();

/* ------- Archivfunktionen ------- */
function deleteRechnung(rnr){
    let archiv = JSON.parse(localStorage.getItem("archiv"));
    archiv = archiv.filter(x => x.rnr !== String(rnr));
    localStorage.setItem("archiv", JSON.stringify(archiv));
    loadArchiv();
}

function editRechnung(r){
    rnr.value = r.rnr;
    kunde.value = r.kunde;
    datum.value = r.datum;
    summe.value = r.summe;

    posBody.innerHTML = "";
    r.positionen.forEach(p=>addPosition(p.desc,p.price));
}

function previewArchiv(r){
    prepareDocument(r);
    window.print();
}

function clearRechnung(){
    rnr.value = "";
    kunde.value = "";
    datum.value = "";
    summe.value = "";
    posBody.innerHTML = "";
}
</script>

</body>
</html>
