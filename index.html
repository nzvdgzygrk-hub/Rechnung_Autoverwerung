<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Rechnungsprogramm – Kleinunternehmer PDF Only (Archiv)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- html2pdf.js für PDF ohne Browser-Fußzeile -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* ===== ALLGEMEINES DESIGN ===== */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #eef0f4;
}
header {
    background: #1f2937;
    color: white;
    padding: 20px;
    font-size: 22px;
    text-align: center;
}
.container {
    max-width: 980px;
    margin: auto;
    padding: 20px;
}
.box {
    background: white;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 12px;
    box-shadow: 0 0 12px rgba(0,0,0,0.12);
}
h2 {
    margin-top: 0;
    border-left: 5px solid #1f2937;
    padding-left: 10px;
}

/* ===== EINGABEFELDER ===== */
input {
    width: 100%;
    padding: 10px;
    margin-bottom: 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    text-align: center;
}

/* ===== BUTTONS ===== */
button {
    padding: 10px 14px;
    margin: 5px;
    border: none;
    border-radius: 6px;
    font-size: 15px;
    cursor: pointer;
}
.save { background: #16a34a; color: white; }
.clear { background: #dc2626; color: white; }
.edit { background: #ea580c; color: white; }
.delete { background: #8b0000; color: white; }
.pdfBtn { background: #2563eb; color: white; }

/* ===== TABELLEN ===== */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
th,td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    text-align: center;
}
th { background: #f3f4f6; }

/* ===== ARCHIV ===== */
.archiv-entry {
    padding: 10px 0;
    border-bottom: 1px solid #ddd;
    font-size: 15px;
}

/* ===== PRINT ===== */
@media print {
    .no-print { display: none !important; }
}
</style>
</head>
<body>

<header>Rechnungsprogramm – Archiv PDF Version</header>

<div class="container">

<!-- ======================================
     FIRMENDATEN
======================================= -->
<div class="box no-print">
    <h2>Firmendaten</h2>
    <img src="Logo.png" style="width:120px;">

    <input id="firma" placeholder="Firma">
    <input id="adresse" placeholder="Adresse">
    <input id="email" placeholder="E-Mail">
    <input id="telefon" placeholder="Telefon">

    <button class="save" id="btnSaveFirma">Firmendaten speichern</button>
</div>


<!-- ======================================
     RECHNUNG ERSTELLEN
======================================= -->
<div class="box">
    <h2 class="no-print">Rechnung erstellen</h2>

    <div class="no-print">
        <input id="rnr" placeholder="Rechnungsnummer">
        <input id="kunde" placeholder="Kunde">
        <input id="datum" type="date">

        <h3>Positionen</h3>

        <table>
            <thead>
                <tr>
                    <th>Beschreibung</th>
                    <th>Preis (€)</th>
                    <th>Aktion</th>
                </tr>
            </thead>
            <tbody id="posBody"></tbody>
        </table>

        <button id="btnAddPos">+ Position</button>

        <h3>Gesamt</h3>
        <input id="summe" readonly style="font-weight:bold; background:#e5e7eb;">

        <button class="save" id="btnSaveRechnung">Rechnung speichern</button>
        <button class="clear" id="btnClear">Felder leeren</button>
    </div>


    <!-- ======================================
         VERSTECKTER PDF-BEREICH
    ======================================= -->
    <div id="pdfArea" style="display:none; background:white; padding:20px;">

        <div style="display:flex; gap:20px;">
            <img src="Logo.png" style="width:90px;">
            <div>
                <b><span id="p_firma"></span></b><br>
                <span id="p_adresse"></span><br>
                <span id="p_email"></span><br>
                <span id="p_telefon"></span>
            </div>
        </div>

        <h1 style="text-align:center; margin:25px 0;">Rechnung</h1>

        <p><b>Rechnungsnummer:</b> <span id="p_rnr"></span></p>
        <p><b>Kunde:</b> <span id="p_kunde"></span></p>
        <p><b>Datum:</b> <span id="p_datum"></span></p>

        <table style="margin-top:20px;">
            <thead>
                <tr>
                    <th>Beschreibung</th>
                    <th>Preis (€)</th>
                </tr>
            </thead>
            <tbody id="p_pos"></tbody>
        </table>

        <h2 style="text-align:right; margin-top:25px;">
            Gesamt: <span id="p_summe"></span> €
        </h2>

        <p style="font-weight:bold; margin-top:25px;">
            Gemäß §19 UStG wird keine Umsatzsteuer berechnet.
        </p>

        <div style="margin-top:35px;">
            <b>Betrag erhalten – bestätigt durch Unterschrift:</b><br><br>
            <div style="border-bottom:2px solid black; width:260px; height:40px;"></div>
        </div>
    </div>
</div>


<!-- ======================================
     ARCHIV
======================================= -->
<div class="box no-print">
    <h2>Archiv</h2>
    <div id="archivList"></div>
</div>


</div> <!-- container -->


<script>
/******************************************************
 *  KURZ HELFER
 ******************************************************/
const $ = id => document.getElementById(id);
function today() { return new Date().toISOString().split("T")[0]; }
$("datum").value = today();


/******************************************************
 *  FIRMENDATEN LADEN + SPEICHERN
 ******************************************************/
function loadFirma() {
    $("firma").value   = localStorage.getItem("firma")   || "";
    $("adresse").value = localStorage.getItem("adresse") || "";
    $("email").value   = localStorage.getItem("email")   || "";
    $("telefon").value = localStorage.getItem("telefon") || "";
}
loadFirma();

$("btnSaveFirma").addEventListener("click", () => {
    localStorage.setItem("firma", $("firma").value);
    localStorage.setItem("adresse", $("adresse").value);
    localStorage.setItem("email", $("email").value);
    localStorage.setItem("telefon", $("telefon").value);
    alert("Firmendaten gespeichert!");
});


/******************************************************
 *  POSITIONEN
 ******************************************************/
function addPos(desc="", price="") {
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td><input class="p_desc" value="${desc}"></td>
        <td><input class="p_price" value="${price}"></td>
        <td><button class="delete btnDelRow">X</button></td>
    `;

    tr.querySelector(".p_price").oninput = calcSum;
    tr.querySelector(".p_desc").oninput = calcSum;

    tr.querySelector(".btnDelRow").onclick = () => {
        tr.remove(); calcSum();
    };

    $("posBody").appendChild(tr);
    calcSum();
}
$("btnAddPos").addEventListener("click", () => addPos());


function calcSum() {
    let total = 0;
    document.querySelectorAll(".p_price").forEach(p => {
        total += parseFloat(p.value.replace(",", ".")) || 0;
    });
    $("summe").value = total.toFixed(2);
}


/******************************************************
 *  RECHNUNG SPEICHERN
 ******************************************************/
$("btnSaveRechnung").addEventListener("click", () => {
    if (!$("rnr").value) return alert("Rechnungsnummer fehlt");

    const r = collectRechnung();
    let archiv = JSON.parse(localStorage.getItem("archiv") || "[]");

    archiv.push(r);
    archiv.sort((a,b)=>a.rnr.localeCompare(b.rnr,"de",{numeric:true}));

    localStorage.setItem("archiv", JSON.stringify(archiv));
    loadArchiv();
    alert("Gespeichert!");
});


function collectRechnung() {
    return {
        id: Date.now(),
        rnr: $("rnr").value,
        kunde: $("kunde").value,
        datum: $("datum").value,
        summe: $("summe").value,
        positionen: [...document.querySelectorAll("#posBody tr")].map(tr=>({
            desc: tr.querySelector(".p_desc").value,
            price: tr.querySelector(".p_price").value
        }))
    };
}


/******************************************************
 *  FELDER LEEREN
 ******************************************************/
$("btnClear").addEventListener("click", () => {
    $("rnr").value = "";
    $("kunde").value = "";
    $("datum").value = today();
    $("posBody").innerHTML = "";
    $("summe").value = "";
});


/******************************************************
 *  ARCHIV LADEN
 ******************************************************/
function loadArchiv() {
    const archiv = JSON.parse(localStorage.getItem("archiv") || "[]");
    $("archivList").innerHTML = "";

    archiv.forEach(r => {
        const row = document.createElement("div");
        row.className = "archiv-entry";
        row.innerHTML = `<b>#${r.rnr}</b> – ${r.kunde} – ${r.summe} €<br>`;

        let b1 = document.createElement("button");
        b1.className="edit";
        b1.textContent="Bearbeiten";
        b1.onclick=()=>editRechnung(r.id);

        let b2 = document.createElement("button");
        b2.className="pdfBtn";
        b2.textContent="PDF";
        b2.onclick=()=>makePDF(r.id);

        let b3 = document.createElement("button");
        b3.className="delete";
        b3.textContent="Löschen";
        b3.onclick=()=>delRechnung(r.id);

        row.appendChild(b1);
        row.appendChild(b2);
        row.appendChild(b3);

        $("archivList").appendChild(row);
    });
}
loadArchiv();


/******************************************************
 *  RECHNUNG BEARBEITEN
 ******************************************************/
function getRechnung(id) {
    return JSON.parse(localStorage.getItem("archiv") || "[]")
           .find(x => x.id === id);
}

function editRechnung(id) {
    const r = getRechnung(id);

    $("rnr").value = r.rnr;
    $("kunde").value = r.kunde;
    $("datum").value = r.datum;

    $("posBody").innerHTML = "";
    r.positionen.forEach(p => addPos(p.desc, p.price));

    calcSum();
}


/******************************************************
 *  RECHNUNG LÖSCHEN
 ******************************************************/
function delRechnung(id) {
    let archiv = JSON.parse(localStorage.getItem("archiv") || "[]");
    archiv = archiv.filter(x => x.id !== id);
    localStorage.setItem("archiv", JSON.stringify(archiv));
    loadArchiv();
}


/******************************************************
 *  PDF ERZEUGEN (iPHONE FIX, 1 SEITE)
 ******************************************************/
function makePDF(id) {
    const r = getRechnung(id);

    // Firmendaten einsetzen
    $("p_firma").innerText   = $("firma").value;
    $("p_adresse").innerText = $("adresse").value;
    $("p_email").innerText   = $("email").value;
    $("p_telefon").innerText = $("telefon").value;

    // Rechnungsdaten
    $("p_rnr").innerText = r.rnr;
    $("p_kunde").innerText = r.kunde;
    $("p_datum").innerText = r.datum;
    $("p_summe").innerText = r.summe;

    const pos = $("p_pos");
    pos.innerHTML = "";
    r.positionen.forEach(p => {
        pos.innerHTML += `<tr><td>${p.desc}</td><td>${p.price}</td></tr>`;
    });

    const pdfElement = $("pdfArea");
    pdfElement.style.display = "block";

    const opt = {
        margin: 0,
        filename: `Rechnung_${r.rnr}.pdf`,
        html2canvas: {
            scale: 2.8,
            useCORS: true,
            backgroundColor: "#FFFFFF",
        },
        jsPDF: {
            unit: "mm",
            format: "a4",
            orientation: "portrait",
        },
        pagebreak: { mode: ["avoid-all"] }
    };

    html2pdf().set(opt).from(pdfElement).save()
    .then(()=>{
        pdfElement.style.display = "none";
    });
}

</script>

</body>
</html>
