<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Rechnungsprogramm – PERIC Autopflege</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- jsPDF + html2canvas für professionelles PDF (ohne Browser-Fußzeile) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #eef0f4;
    }
    header {
      background: #1f2937;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 22px;
    }
    .container {
      max-width: 980px;
      margin: 0 auto;
      padding: 20px;
    }
    .box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0,0,0,0.12);
      margin-bottom: 20px;
    }
    h2 {
      margin-top: 0;
      border-left: 5px solid #1f2937;
      padding-left: 10px;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      text-align: center;
      box-sizing: border-box;
    }

    button {
      padding: 10px 14px;
      margin: 5px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 15px;
    }
    .save   { background:#16a34a; color:white; }
    .clear  { background:#dc2626; color:white; }
    .edit   { background:#ea580c; color:white; }
    .delete { background:#8b0000; color:white; }
    .pdfBtn { background:#2563eb; color:white; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      text-align: center;
    }
    th {
      background: #f3f4f6;
    }

    .archiv-entry {
      padding: 10px 0;
      border-bottom: 1px solid #ccc;
      font-size: 15px;
    }

    /* PDF Layout */
    #pdfLayout {
      width: 210mm;
      min-height: 297mm;
      padding: 20mm;
      background: white;
      font-size: 14px;
      box-sizing: border-box;
    }

    @media print {
      .no-print { display:none; }
    }
  </style>
</head>
<body>

<header>Rechnungsprogramm – PERIC Autopflege</header>

<div class="container">

  <!-- FIRMENDATEN -->
  <div class="box no-print">
    <h2>Firmendaten</h2>

    <img src="Logo.png" id="logo" style="width:140px; margin-bottom:10px;" alt="Logo">

    <input id="firma"   placeholder="Firma"   value="PERIC Autopflege">
    <input id="adresse" placeholder="Adresse" value="Simonswälderstr. 43, 79261 Bleibach">
    <input id="telefon" placeholder="Telefon" value="0151 / 26922891">
    <input id="email"   placeholder="E-Mail"  value="m_peric@web.de">
    <input id="steuer"  placeholder="Steuernummer">

    <button class="save" id="btnSaveFirma">Firmendaten speichern</button>
  </div>

  <!-- RECHNUNG ERSTELLEN -->
  <div class="box">
    <h2 class="no-print">Rechnung erstellen</h2>

    <div class="no-print">
      <input id="rnr"   placeholder="Rechnungsnummer">
      <input id="kunde" placeholder="Kunde">
      <input id="datum" type="date">

      <h3>Positionen</h3>
      <table>
        <thead>
        <tr>
          <th>Beschreibung</th>
          <th>Preis (€)</th>
          <th>Aktion</th>
        </tr>
        </thead>
        <tbody id="posBody"></tbody>
      </table>

      <button id="btnAddPos">+ Position</button>

      <h3>Gesamt</h3>
      <input id="summe" readonly style="font-weight:bold; background:#e5e7eb;">

      <button class="save" id="btnSaveRechnung">Rechnung speichern</button>
      <button class="clear" id="btnClear">Felder leeren</button>
    </div>
  </div>

  <!-- ARCHIV -->
  <div class="box no-print">
    <h2>Archiv</h2>
    <div id="archivList"></div>
  </div>

</div>

<!-- PDF-LAYOUT (unsichtbar, wird für PDF genutzt) -->
<div id="pdfLayout" style="display:none;">

  <!-- Header: Logo links (110px), Firmendaten rechts groß -->
  <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:25px;">
    <img src="Logo.png" style="width:110px;" alt="Logo">

    <div style="text-align:right; font-size:15px; line-height:1.5;">
      <b><span id="p_firma"></span></b><br>
      <span id="p_adresse"></span><br>
      Tel: <span id="p_telefon"></span><br>
      E-Mail: <span id="p_email"></span><br>
      <b>Steuernummer:</b> <span id="p_steuer"></span>
    </div>
  </div>

  <h1 style="text-align:center; margin-top:10px; margin-bottom:20px;">RECHNUNG</h1>

  <p><b>Rechnungsnummer:</b> <span id="p_rnr"></span></p>
  <p><b>Kunde:</b> <span id="p_kunde"></span></p>
  <p><b>Datum:</b> <span id="p_datum"></span></p>

  <table style="margin-top:20px;">
    <thead>
    <tr>
      <th>Beschreibung</th>
      <th>Preis (€)</th>
    </tr>
    </thead>
    <tbody id="p_pos"></tbody>
  </table>

  <h2 style="text-align:right; margin-top:20px;">
    Gesamt: <span id="p_summe"></span> €
  </h2>

  <p style="margin-top:20px; font-weight:bold;">
    Gemäß §19 UStG wird keine Umsatzsteuer berechnet.
  </p>

  <div style="margin-top:40px;">
    <b>Betrag erhalten – bestätigt durch Unterschrift:</b><br><br>
    <div style="border-bottom:2px solid black; width:260px; height:40px;"></div>
  </div>
</div>

<script>
  const $ = id => document.getElementById(id);

  // Datum automatisch auf heute
  $("datum").value = new Date().toISOString().split("T")[0];

  // Firmendaten laden
  function loadFirma(){
    $("firma").value   = localStorage.getItem("firma")   || "PERIC Autopflege";
    $("adresse").value = localStorage.getItem("adresse") || "Simonswälderstr. 43, 79261 Bleibach";
    $("telefon").value = localStorage.getItem("telefon") || "0151 / 26922891";
    $("email").value   = localStorage.getItem("email")   || "m_peric@web.de";
    $("steuer").value  = localStorage.getItem("steuer")  || "";
  }
  loadFirma();

  // Firmendaten speichern
  $("btnSaveFirma").onclick = () => {
    localStorage.setItem("firma",   $("firma").value);
    localStorage.setItem("adresse", $("adresse").value);
    localStorage.setItem("telefon", $("telefon").value);
    localStorage.setItem("email",   $("email").value);
    localStorage.setItem("steuer",  $("steuer").value);
    alert("Firmendaten gespeichert!");
  };

  // Position hinzufügen
  $("btnAddPos").onclick = () => addPos();

  function addPos(desc="", price=""){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="p_desc" value="${desc}"></td>
      <td><input class="p_price" value="${price}"></td>
      <td><button class="delete">X</button></td>
    `;
    tr.querySelector(".delete").onclick = () => { tr.remove(); calcSum(); };
    tr.querySelector(".p_price").oninput = calcSum;
    tr.querySelector(".p_desc").oninput = calcSum;

    $("posBody").appendChild(tr);
    calcSum();
  }

  // Summe berechnen
  function calcSum(){
    let t = 0;
    document.querySelectorAll(".p_price").forEach(p=>{
      t += parseFloat(p.value.replace(",", ".")) || 0;
    });
    $("summe").value = t.toFixed(2);
  }

  // Rechnung sammeln
  function collectRechnung(){
    return {
      id: Date.now(),
      rnr: $("rnr").value,
      kunde: $("kunde").value,
      datum: $("datum").value,
      summe: $("summe").value,
      positionen: [...document.querySelectorAll("#posBody tr")].map(tr=>({
        desc: tr.querySelector(".p_desc").value,
        price: tr.querySelector(".p_price").value
      }))
    };
  }

  // Rechnung speichern
  $("btnSaveRechnung").onclick = () => {
    if (!$("rnr").value) {
      alert("Rechnungsnummer fehlt!");
      return;
    }
    const r = collectRechnung();
    let archiv = JSON.parse(localStorage.getItem("archiv") || "[]");
    archiv.push(r);
    archiv.sort((a,b)=>a.rnr.localeCompare(b.rnr,"de",{numeric:true}));
    localStorage.setItem("archiv", JSON.stringify(archiv));
    loadArchiv();
    alert("Rechnung gespeichert!");
  };

  // Felder leeren
  $("btnClear").onclick = () => {
    $("rnr").value = "";
    $("kunde").value = "";
    $("datum").value = new Date().toISOString().split("T")[0];
    $("posBody").innerHTML = "";
    $("summe").value = "";
  };

  // Archiv laden
  function loadArchiv(){
    const archiv = JSON.parse(localStorage.getItem("archiv") || "[]");
    $("archivList").innerHTML = "";

    archiv.forEach(r=>{
      const row = document.createElement("div");
      row.className = "archiv-entry";
      row.innerHTML = `<b>#${r.rnr}</b> – ${r.kunde} – ${r.summe} €<br>`;

      const bEdit = document.createElement("button");
      bEdit.className = "edit";
      bEdit.textContent = "Bearbeiten";
      bEdit.onclick = () => editRechnung(r.id);

      const bPdf = document.createElement("button");
      bPdf.className = "pdfBtn";
      bPdf.textContent = "PDF";
      bPdf.onclick = () => makePDF(r.id);

      const bDel = document.createElement("button");
      bDel.className = "delete";
      bDel.textContent = "Löschen";
      bDel.onclick = () => deleteRechnung(r.id);

      row.appendChild(bEdit);
      row.appendChild(bPdf);
      row.appendChild(bDel);

      $("archivList").appendChild(row);
    });
  }
  loadArchiv();

  function getRechnung(id){
    return JSON.parse(localStorage.getItem("archiv") || "[]").find(x=>x.id===id);
  }

  // Rechnung bearbeiten
  function editRechnung(id){
    const r = getRechnung(id);
    if (!r) return;

    $("rnr").value   = r.rnr;
    $("kunde").value = r.kunde;
    $("datum").value = r.datum;

    $("posBody").innerHTML = "";
    r.positionen.forEach(p=>addPos(p.desc, p.price));
    calcSum();
  }

  // Rechnung löschen
  function deleteRechnung(id){
    let archiv = JSON.parse(localStorage.getItem("archiv") || "[]");
    archiv = archiv.filter(x=>x.id !== id);
    localStorage.setItem("archiv", JSON.stringify(archiv));
    loadArchiv();
  }

  // PDF generieren (DIN A4, 1 Seite, mit deinem Kopf)
  async function makePDF(id){
    const r = getRechnung(id);
    if (!r) return;

    // Kopf aus Eingabefeldern
    $("p_firma").innerText   = $("firma").value;
    $("p_adresse").innerText = $("adresse").value;
    $("p_telefon").innerText = $("telefon").value;
    $("p_email").innerText   = $("email").value;
    $("p_steuer").innerText  = $("steuer").value || "-";

    // Rechnungsdaten
    $("p_rnr").innerText   = r.rnr;
    $("p_kunde").innerText = r.kunde;
    $("p_datum").innerText = r.datum;
    $("p_summe").innerText = r.summe;

    const pos = $("p_pos");
    pos.innerHTML = "";
    r.positionen.forEach(p=>{
      pos.innerHTML += `<tr><td>${p.desc}</td><td>${p.price}</td></tr>`;
    });

    const node = $("pdfLayout");
    node.style.display = "block";

    const canvas = await html2canvas(node, { scale: 3 });
    const imgData = canvas.toDataURL("image/png");

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
      orientation: "portrait",
      unit: "mm",
      format: "a4"
    });

    const pdfWidth = 210;
    const imgHeight = canvas.height * pdfWidth / canvas.width;

    pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, imgHeight);
    pdf.save(`Rechnung_${r.rnr}.pdf`);

    node.style.display = "none";
  }
</script>

</body>
</html>
