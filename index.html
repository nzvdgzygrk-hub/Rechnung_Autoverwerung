<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Rechnungsprogramm – Kleinunternehmer</title>

<style>
/* ----------- DESIGN ----------- */
body { font-family: Arial; margin: 0; background: #f2f2f2; }
header { background: #333; color: white; padding: 20px; text-align: center; }

.container {
    max-width: 900px;
    margin: auto;
    padding: 20px;
}

.box {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
}

h2 { border-left: 5px solid #333; padding-left: 10px; }

input, textarea {
    width: 100%;
    padding: 8px;
    margin: 5px 0 10px 0;
    border-radius: 5px;
    border: 1px solid #ccc;
    text-align: center;
}

button {
    padding: 8px 14px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-right: 10px;
    margin-top: 5px;
}

.save { background: #27ae60; color: white; }
.clear { background: #c0392b; color: white; }
.print { background: #2980b9; color: white; }
.edit { background: #d35400; color: white; }
.delete { background: #8b0000; color: white; }

/* ----------- POSITIONEN TABELLE ----------- */
table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
}
th, td {
    padding: 6px;
    border-bottom: 1px solid #ccc;
    text-align: center;
}
th { background: #eee; }

/* ----------- DRUCKANSICHT ----------- */
@media print {
    header, .no-print, .box:nth-child(1), .box:nth-child(3) {
        display: none !important;
    }
    body { background: white; }
    #printArea {
        display: block;
        padding: 20px;
        font-size: 14px;
    }
}
</style>
</head>
<body>

<header>
    <h1>Rechnungsprogramm – Kleinunternehmer</h1>
</header>

<div class="container">

    <!-- FIRMENDATEN -->
    <div class="box no-print">
        <h2>Firmendaten</h2>
        <img src="Logo.png" id="logoPreview" style="width:140px; margin-bottom:10px;">
        <input id="firma" placeholder="Firmenname">
        <input id="adresse" placeholder="Adresse">
        <input id="email" placeholder="E-Mail">
        <input id="telefon" placeholder="Telefon">
        <button class="save" onclick="saveFirmendaten()">Firmendaten speichern</button>
    </div>

    <!-- RECHNUNG -->
    <div class="box">
        <h2 class="no-print">Rechnung erstellen</h2>

        <div class="no-print">
            <input id="rnr" placeholder="Rechnungsnummer">

            <input id="kunde" placeholder="Kunde">
            <input id="datum" type="date">

            <h3>Positionen</h3>

            <table id="posTable">
                <thead>
                    <tr>
                        <th>Beschreibung</th>
                        <th>Preis (€)</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody id="posBody"></tbody>
            </table>

            <button onclick="addPosition()">+ Position hinzufügen</button>

            <h3>Gesamtbetrag (€)</h3>
            <input id="summe">

            <button class="save" onclick="saveRechnung()">Rechnung speichern</button>
            <button class="clear" onclick="clearRechnung()">Felder leeren</button>
            <button class="print" onclick="directPrint()">Drucken</button>
        </div>

        <!-- DRUCKBEREICH -->
        <div id="printArea" style="display:none;">
            <img src="Logo.png" style="width:140px;"><br><br>

            <h2>Rechnung</h2>
            <b>Rechnungsnummer:</b> <span id="p_rnr"></span><br>
            <b>Kunde:</b> <span id="p_kunde"></span><br>
            <b>Datum:</b> <span id="p_datum"></span><br><br>

            <b>Firma:</b> <span id="p_firma"></span><br>
            <b>Adresse:</b> <span id="p_adresse"></span><br>
            <b>Email:</b> <span id="p_email"></span><br>
            <b>Telefon:</b> <span id="p_telefon"></span><br><br>

            <table>
                <thead>
                    <tr><th>Beschreibung</th><th>Preis (€)</th></tr>
                </thead>
                <tbody id="p_pos"></tbody>
            </table>

            <h3>Gesamtbetrag: <span id="p_summe"></span> €</h3>

            <p style="font-weight:bold; margin-top:20px;">
                Gemäß §19 UStG beinhaltet dieser Betrag keine Umsatzsteuer.
            </p>
        </div>
    </div>

    <!-- ARCHIV -->
    <div class="box no-print">
        <h2>Archiv</h2>
        <div id="archivList"></div>
    </div>

</div>

<script>
/* ----------------------------------
   Firmendaten Laden/Speichern
---------------------------------- */
function loadFirmendaten() {
    firma.value = localStorage.getItem("firma") || "";
    adresse.value = localStorage.getItem("adresse") || "";
    email.value = localStorage.getItem("email") || "";
    telefon.value = localStorage.getItem("telefon") || "";
}
loadFirmendaten();

function saveFirmendaten() {
    localStorage.setItem("firma", firma.value);
    localStorage.setItem("adresse", adresse.value);
    localStorage.setItem("email", email.value);
    localStorage.setItem("telefon", telefon.value);
    alert("Firmendaten gespeichert!");
}

/* ----------------------------------
   Positionen
---------------------------------- */
function addPosition(desc = "", price = "") {
    const tr = document.createElement("tr");

    tr.innerHTML = `
        <td><input value="${desc}" class="p_desc"></td>
        <td><input value="${price}" class="p_price"></td>
        <td><button onclick="this.parentElement.parentElement.remove()">X</button></td>
    `;
    posBody.appendChild(tr);
}

/* ----------------------------------
   Rechnung speichern
---------------------------------- */
function saveRechnung() {
    const r = {
        id: Date.now(),
        rnr: rnr.value,
        kunde: kunde.value,
        datum: datum.value,
        summe: summe.value,
        positionen: []
    };

    document.querySelectorAll("#posBody tr").forEach(row => {
        r.positionen.push({
            desc: row.querySelector(".p_desc").value,
            price: row.querySelector(".p_price").value
        });
    });

    let archiv = JSON.parse(localStorage.getItem("archiv")) || [];

    archiv.push(r);
    archiv.sort((a, b) => Number(a.rnr) - Number(b.rnr));

    localStorage.setItem("archiv", JSON.stringify(archiv));

    alert("Rechnung gespeichert!");
    loadArchiv();
}

/* ----------------------------------
   Druckdaten vorbereiten
---------------------------------- */
function preparePrint(r) {
    p_firma.innerText = firma.value;
    p_adresse.innerText = adresse.value;
    p_email.innerText = email.value;
    p_telefon.innerText = telefon.value;

    p_rnr.innerText = r.rnr;
    p_kunde.innerText = r.kunde;
    p_datum.innerText = r.datum;
    p_summe.innerText = r.summe;

    p_pos.innerHTML = "";
    r.positionen.forEach(p => {
        p_pos.innerHTML += `<tr><td>${p.desc}</td><td>${p.price}</td></tr>`;
    });

    printArea.style.display = "block";
}

function directPrint() {
    const r = {
        rnr: rnr.value,
        kunde: kunde.value,
        datum: datum.value,
        summe: summe.value,
        positionen: []
    };

    document.querySelectorAll("#posBody tr").forEach(row => {
        r.positionen.push({
            desc: row.querySelector(".p_desc").value,
            price: row.querySelector(".p_price").value
        });
    });

    preparePrint(r);
    window.print();
}

/* ----------------------------------
   Archiv
---------------------------------- */
function loadArchiv() {
    let archiv = JSON.parse(localStorage.getItem("archiv")) || [];
    const list = document.getElementById("archivList");
    list.innerHTML = "";

    archiv.forEach(r => {
        const div = document.createElement("div");
        div.style.marginBottom = "10px";

        div.innerHTML = `
            <b>Rechnung #${r.rnr}</b><br>
            ${r.kunde} – ${r.datum} – ${r.summe} €<br>
            <button class="edit" onclick='editRechnung(${r.id})'>Bearbeiten</button>
            <button class="print" onclick='printArchiv(${r.id})'>Drucken</button>
            <button class="delete" onclick='deleteRechnung(${r.id})'>Löschen</button>
        `;

        list.appendChild(div);
    });
}
loadArchiv();

/* ----------------------------------
   Archiv-Funktionen
---------------------------------- */
function editRechnung(id) {
    let archiv = JSON.parse(localStorage.getItem("archiv"));
    let r = archiv.find(x => x.id === id);

    rnr.value = r.rnr;
    kunde.value = r.kunde;
    datum.value = r.datum;
    summe.value = r.summe;

    posBody.innerHTML = "";
    r.positionen.forEach(p => addPosition(p.desc, p.price));

    alert("Rechnung geladen.");
}

function deleteRechnung(id) {
    let archiv = JSON.parse(localStorage.getItem("archiv"));
    archiv = archiv.filter(x => x.id !== id);
    localStorage.setItem("archiv", JSON.stringify(archiv));
    loadArchiv();
}

function printArchiv(id) {
    let archiv = JSON.parse(localStorage.getItem("archiv"));
    let r = archiv.find(x => x.id === id);
    preparePrint(r);
    window.print();
}

/* ---------------------------------- */
function clearRechnung() {
    rnr.value = "";
    kunde.value = "";
    datum.value = "";
    summe.value = "";
    posBody.innerHTML = "";
}
</script>

</body>
</html>
