<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Rechnungsprogramm – Kleinunternehmer</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: Arial; margin: 0; background: #eef0f4;
}
header {
    background: #1f2937; color: white; padding: 20px;
    text-align: center; font-size: 22px;
}
.container { max-width: 950px; margin: auto; padding: 20px; }

.box {
    background: white; padding: 20px; border-radius: 12px;
    margin-bottom: 20px; box-shadow: 0 0 15px rgba(0,0,0,0.1);
}

h2 { margin-top: 0; border-left: 5px solid #1f2937; padding-left: 10px; }

input {
    width: 100%; padding: 10px; margin-bottom: 12px;
    border-radius: 6px; border: 1px solid #ccc; text-align: center;
}

button {
    padding: 10px 18px; border: none; border-radius: 6px;
    cursor: pointer; margin-right: 10px; margin-top: 5px; font-size: 15px;
}
.save   { background: #16a34a; color: white; }
.clear  { background: #dc2626; color: white; }
.edit   { background: #ea580c; color: white; }
.delete { background: #8b0000; color: white; }
.printBtn { background: #2563eb; color: white; }

table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
th { background: #f3f4f6; }

/* KEINE Browser-Fußzeile beim Drucken */
@page { size: A4; margin: 0; }

@media print {
    header, .no-print { display: none !important; }
    body { margin: 0 !important; background: white; }
    #pdfArea { display: block !important; }
}
</style>
</head>
<body>

<header>Rechnungsprogramm – Kleinunternehmer</header>

<div class="container">

<!-- Firmendaten -->
<div class="box no-print">
    <h2>Firmendaten</h2>
    <img src="Logo.png" style="width:120px; margin-bottom:10px;">
    <input id="firma" placeholder="Firma">
    <input id="adresse" placeholder="Adresse">
    <input id="email" placeholder="E-Mail">
    <input id="telefon" placeholder="Telefon">
    <button class="save" onclick="saveFirmendaten()">Speichern</button>
</div>

<!-- Rechnung erstellen -->
<div class="box">
    <h2 class="no-print">Rechnung erstellen</h2>

    <div class="no-print">
        <input id="rnr" placeholder="Rechnungsnummer">
        <input id="kunde" placeholder="Kunde">
        <input id="datum" type="date">

        <h3>Positionen</h3>
        <table>
            <thead>
                <tr><th>Beschreibung</th><th>Preis (€)</th><th>Aktion</th></tr>
            </thead>
            <tbody id="posBody"></tbody>
        </table>

        <button onclick="addPosition()">+ Position hinzufügen</button>

        <h3>Gesamtsumme (€)</h3>
        <input id="summe" readonly style="background:#e5e7eb; font-weight:bold;">

        <button class="save" onclick="saveRechnung()">Rechnung speichern</button>
        <button class="clear" onclick="clearRechnung()">Leeren</button>
    </div>

    <!-- Drucklayout -->
    <div id="pdfArea" style="
        display:none; background:white;
        width:190mm; margin:auto; padding:15mm; box-sizing:border-box;
    ">
        <div style="display:flex; gap:20px;">
            <img src="Logo.png" style="width:90px;">
            <div>
                <b><span id="p_firma"></span></b><br>
                <span id="p_adresse"></span><br>
                <span id="p_email"></span><br>
                <span id="p_telefon"></span>
            </div>
        </div>

        <h1 style="text-align:center; margin-top:25px;">Rechnung</h1>

        <p><b>Rechnungsnummer:</b> <span id="p_rnr"></span></p>
        <p><b>Kunde:</b> <span id="p_kunde"></span></p>
        <p><b>Datum:</b> <span id="p_datum"></span></p>

        <table style="margin-top:20px;">
            <thead><tr><th>Beschreibung</th><th>Preis (€)</th></tr></thead>
            <tbody id="p_pos"></tbody>
        </table>

        <h2 style="text-align:right;">Gesamt: <span id="p_summe"></span> €</h2>

        <p style="margin-top:20px; font-weight:bold;">
            Gemäß §19 UStG wird keine Umsatzsteuer berechnet.
        </p>

        <div style="margin-top:40px;">
            <b>Betrag erhalten – bestätigt durch Unterschrift:</b><br><br>
            <div style="border-bottom:2px solid black; width:300px; height:40px;"></div>
        </div>
    </div>
</div>

<!-- Archiv -->
<div class="box no-print">
    <h2>Archiv</h2>
    <div id="archivList"></div>
</div>

</div>

<script>
/* Datum automatisch auf heute setzen */
document.getElementById("datum").value = new Date().toISOString().split("T")[0];

/* Firmendaten laden */
function saveFirmendaten(){
    localStorage.setItem("firma", firma.value);
    localStorage.setItem("adresse", adresse.value);
    localStorage.setItem("email", email.value);
    localStorage.setItem("telefon", telefon.value);
}
function loadFirmendaten(){
    firma.value   = localStorage.getItem("firma")   || "";
    adresse.value = localStorage.getItem("adresse") || "";
    email.value   = localStorage.getItem("email")   || "";
    telefon.value = localStorage.getItem("telefon") || "";
}
loadFirmendaten();

/* Positionen */
function addPosition(desc="", price=""){
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td><input class="p_desc" value="${desc}" oninput="calcSum()"></td>
        <td><input class="p_price" value="${price}" oninput="calcSum()"></td>
        <td><button onclick="this.parentElement.parentElement.remove(); calcSum();">X</button></td>
    `;
    posBody.appendChild(tr);
    calcSum();
}

/* Summe berechnen */
function calcSum(){
    let sum = 0;
    document.querySelectorAll(".p_price").forEach(p=>{
        let n = parseFloat(p.value.replace(",", ".")) || 0;
        sum += n;
    });
    document.getElementById("summe").value = sum.toFixed(2);
}

/* Rechnung speichern */
function saveRechnung(){
    const r = {
        id: Date.now(),
        rnr: rnr.value,
        kunde: kunde.value,
        datum: datum.value,
        summe: summe.value,
        positionen: [...document.querySelectorAll("#posBody tr")].map(row=>({
            desc: row.querySelector(".p_desc").value,
            price: row.querySelector(".p_price").value
        }))
    };

    let archiv = JSON.parse(localStorage.getItem("archiv")||"[]");
    archiv.push(r);

    archiv.sort((a,b)=>a.rnr.localeCompare(b.rnr,"de",{numeric:true}));

    localStorage.setItem("archiv", JSON.stringify(archiv));
    loadArchiv();
    alert("Rechnung gespeichert!");
}

/* Archiv anzeigen */
function loadArchiv(){
    const archiv = JSON.parse(localStorage.getItem("archiv")||"[]");
    archivList.innerHTML = "";

    archiv.forEach(r=>{
        const div = document.createElement("div");
        div.innerHTML = `
            <b>#${r.rnr}</b> – ${r.kunde} – ${r.summe} €<br>
        `;

        const b1 = document.createElement("button");
        b1.className="edit"; b1.innerText="Bearbeiten";
        b1.onclick = ()=>editRechnung(r.id);

        const b2 = document.createElement("button");
        b2.className="printBtn"; b2.innerText="Drucken";
        b2.onclick = ()=>printRechnung(r.id);

        const b3 = document.createElement("button");
        b3.className="delete"; b3.innerText="Löschen";
        b3.onclick = ()=>deleteRechnung(r.id);

        div.appendChild(b1); div.appendChild(b2); div.appendChild(b3);
        archivList.appendChild(div);
    });
}
loadArchiv();

/* Rechnung bearbeiten */
function editRechnung(id){
    const archiv = JSON.parse(localStorage.getItem("archiv"));
    const r = archiv.find(x=>x.id===id);

    rnr.value   = r.rnr;
    kunde.value = r.kunde;
    datum.value = r.datum;

    posBody.innerHTML = "";
    r.positionen.forEach(p=>addPosition(p.desc,p.price));

    calcSum();
}

/* Rechnung löschen */
function deleteRechnung(id){
    let archiv = JSON.parse(localStorage.getItem("archiv"));
    archiv = archiv.filter(x=>x.id!==id);
    localStorage.setItem("archiv", JSON.stringify(archiv));
    loadArchiv();
}

/* Drucklayout aufbauen */
function printRechnung(id){
    const archiv = JSON.parse(localStorage.getItem("archiv"));
    const r = archiv.find(x=>x.id===id);

    p_firma.innerText   = firma.value;
    p_adresse.innerText = adresse.value;
    p_email.innerText   = email.value;
    p_telefon.innerText = telefon.value;

    p_rnr.innerText   = r.rnr;
    p_kunde.innerText = r.kunde;
    p_datum.innerText = r.datum;
    p_summe.innerText = r.summe;

    p_pos.innerHTML = "";
    r.positionen.forEach(p=>{
        p_pos.innerHTML += `<tr><td>${p.desc}</td><td>${p.price}</td></tr>`;
    });

    window.print();
}

/* Felder leeren */
function clearRechnung(){
    rnr.value = "";
    kunde.value = "";
    datum.value = new Date().toISOString().split("T")[0];
    posBody.innerHTML = "";
    summe.value = "";
}
</script>

</body>
</html>
