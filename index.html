<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Rechnungsprogramm – Professionelle PDF Version</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- jsPDF + html2canvas (beste, stabile Lösung) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #eef0f4;
}
header {
    background: #1f2937;
    color: white;
    padding: 20px;
    text-align: center;
    font-size: 22px;
}
.container {
    max-width: 980px;
    margin: auto;
    padding: 20px;
}
.box {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 12px rgba(0,0,0,0.12);
    margin-bottom: 20px;
}
input {
    width: 100%;
    padding: 10px;
    margin-bottom: 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    text-align: center;
}
button {
    padding: 10px 14px;
    margin: 5px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 15px;
}
.save { background:#16a34a; color:white; }
.clear { background:#dc2626; color:white; }
.edit { background:#ea580c; color:white; }
.delete { background:#8b0000; color:white; }
.pdfBtn { background:#2563eb; color:white; }

table {
    width:100%;
    border-collapse: collapse;
}
th,td {
    padding:10px;
    border-bottom:1px solid #ccc;
    text-align:center;
}
th {
    background:#f3f4f6;
}

/* Archiv */
.archiv-entry {
    padding:10px 0;
    border-bottom:1px solid #ccc;
    font-size:15px;
}

/* PDF Layout */
#pdfLayout {
    width: 210mm;
    min-height: 297mm;
    padding: 20mm;
    background: white;
    font-size: 14px;
    box-sizing: border-box;
}
</style>
</head>
<body>

<header>Rechnungsprogramm – Profi PDF</header>

<div class="container">

<!-- FIRMENDATEN -->
<div class="box no-print">
    <h2>Firmendaten</h2>

    <img src="Logo.png" id="logo" style="width:140px; margin-bottom:10px;">

    <input id="firma" placeholder="Firma">
    <input id="adresse" placeholder="Adresse">
    <input id="email" placeholder="E-Mail">
    <input id="telefon" placeholder="Telefon">

    <button class="save" id="btnSaveFirma">Firmendaten speichern</button>
</div>

<!-- RECHNUNG ERSTELLEN -->
<div class="box">
    <h2 class="no-print">Rechnung erstellen</h2>

    <div class="no-print">
        <input id="rnr" placeholder="Rechnungsnummer">
        <input id="kunde" placeholder="Kunde">
        <input id="datum" type="date">

        <h3>Positionen</h3>

        <table>
            <thead>
                <tr>
                    <th>Beschreibung</th>
                    <th>Preis (€)</th>
                    <th>Aktion</th>
                </tr>
            </thead>
            <tbody id="posBody"></tbody>
        </table>

        <button id="btnAddPos">+ Position</button>

        <h3>Gesamt</h3>
        <input id="summe" readonly style="font-weight:bold; background:#e5e7eb;">

        <button class="save" id="btnSaveRechnung">Rechnung speichern</button>
        <button class="clear" id="btnClear">Felder leeren</button>
    </div>
</div>

<!-- ARCHIV -->
<div class="box no-print">
    <h2>Archiv</h2>
    <div id="archivList"></div>
</div>

</div>

<!-- PDF-LAYOUT (unsichtbar, wird in PDF verwandelt) -->
<div id="pdfLayout" style="display:none;">

    <!-- Kopfbereich A: Logo links, Firmendaten rechts -->
    <div style="display:flex; justify-content:space-between;">
        <img src="Logo.png" style="width:120px;">
        <div style="text-align:right;">
            <b><span id="p_firma"></span></b><br>
            <span id="p_adresse"></span><br>
            <span id="p_email"></span><br>
            <span id="p_telefon"></span><br>
        </div>
    </div>

    <h1 style="text-align:center; margin-top:30px;">RECHNUNG</h1>

    <p><b>Rechnungsnummer:</b> <span id="p_rnr"></span></p>
    <p><b>Kunde:</b> <span id="p_kunde"></span></p>
    <p><b>Datum:</b> <span id="p_datum"></span></p>

    <table style="margin-top:20px;">
        <thead>
            <tr>
                <th>Beschreibung</th>
                <th>Preis (€)</th>
            </tr>
        </thead>
        <tbody id="p_pos"></tbody>
    </table>

    <h2 style="text-align:right; margin-top:20px;">
        Gesamt: <span id="p_summe"></span> €
    </h2>

    <p style="margin-top:20px; font-weight:bold;">
        Gemäß §19 UStG wird keine Umsatzsteuer berechnet.
    </p>

    <div style="margin-top:40px;">
        <b>Betrag erhalten – bestätigt durch Unterschrift:</b><br><br>
        <div style="border-bottom:2px solid black; width:260px; height:40px;"></div>
    </div>
</div>

<script>
// Shortcuts
const $ = id => document.getElementById(id);

// Initial Datum
$("datum").value = new Date().toISOString().split("T")[0];

/* Firmendaten laden */
function loadFirma(){
    $("firma").value = localStorage.getItem("firma") || "";
    $("adresse").value = localStorage.getItem("adresse") || "";
    $("email").value = localStorage.getItem("email") || "";
    $("telefon").value = localStorage.getItem("telefon") || "";
}
loadFirma();

$("btnSaveFirma").onclick = () => {
    localStorage.setItem("firma", $("firma").value);
    localStorage.setItem("adresse", $("adresse").value);
    localStorage.setItem("email", $("email").value);
    localStorage.setItem("telefon", $("telefon").value);
    alert("Firmendaten gespeichert!");
};

/* Positionen */
$("btnAddPos").onclick = () => addPos();

function addPos(desc="", price=""){
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td><input class="p_desc" value="${desc}"></td>
        <td><input class="p_price" value="${price}"></td>
        <td><button class="delete">X</button></td>
    `;
    tr.querySelector(".delete").onclick = () => { tr.remove(); calcSum(); };
    tr.querySelector(".p_price").oninput = calcSum;
    tr.querySelector(".p_desc").oninput = calcSum;

    $("posBody").appendChild(tr);
    calcSum();
}

function calcSum(){
    let t = 0;
    document.querySelectorAll(".p_price").forEach(p=>{
        t += parseFloat(p.value) || 0;
    });
    $("summe").value = t.toFixed(2);
}

/* Rechnung speichern */
$("btnSaveRechnung").onclick = () => {
    if (!$("rnr").value) return alert("Rechnungsnummer fehlt!");

    const r = collectRechnung();
    let archiv = JSON.parse(localStorage.getItem("archiv") || "[]");

    archiv.push(r);
    archiv.sort((a,b)=>a.rnr.localeCompare(b.rnr,"de",{numeric:true}));

    localStorage.setItem("archiv", JSON.stringify(archiv));
    loadArchiv();
    alert("Rechnung gespeichert!");
};

function collectRechnung(){
    return {
        id: Date.now(),
        rnr: $("rnr").value,
        kunde: $("kunde").value,
        datum: $("datum").value,
        summe: $("summe").value,
        positionen: [...document.querySelectorAll("#posBody tr")].map(tr=>({
            desc: tr.querySelector(".p_desc").value,
            price: tr.querySelector(".p_price").value
        }))
    };
}

/* Felder leeren */
$("btnClear").onclick = () => {
    $("rnr").value="";
    $("kunde").value="";
    $("datum").value=new Date().toISOString().split("T")[0];
    $("posBody").innerHTML="";
    $("summe").value="";
};

/* Archiv laden */
function loadArchiv(){
    const archiv = JSON.parse(localStorage.getItem("archiv") || "[]");
    $("archivList").innerHTML="";

    archiv.forEach(r=>{
        const row = document.createElement("div");
        row.className="archiv-entry";
        row.innerHTML = `<b>#${r.rnr}</b> – ${r.kunde} – ${r.summe} € <br>`;

        let b1 = document.createElement("button");
        b1.className="edit"; b1.textContent="Bearbeiten";
        b1.onclick=()=>editRechnung(r.id);

        let b2 = document.createElement("button");
        b2.className="pdfBtn"; b2.textContent="PDF";
        b2.onclick=()=>makePDF(r.id);

        let b3 = document.createElement("button");
        b3.className="delete"; b3.textContent="Löschen";
        b3.onclick=()=>deleteRechnung(r.id);

        row.appendChild(b1);
        row.appendChild(b2);
        row.appendChild(b3);

        $("archivList").appendChild(row);
    });
}
loadArchiv();

// Rechnung bearbeiten
function getR(id){
    return JSON.parse(localStorage.getItem("archiv") || "[]")
           .find(x=>x.id===id);
}

function editRechnung(id){
    const r = getR(id);

    $("rnr").value = r.rnr;
    $("kunde").value = r.kunde;
    $("datum").value = r.datum;

    $("posBody").innerHTML="";
    r.positionen.forEach(p=>addPos(p.desc,p.price));
    calcSum();
}

// Rechnung löschen
function deleteRechnung(id){
    let archiv = JSON.parse(localStorage.getItem("archiv") || "[]");
    archiv = archiv.filter(x=>x.id!==id);
    localStorage.setItem("archiv", JSON.stringify(archiv));
    loadArchiv();
}

/***********************
 *  PROFESSIONELLES PDF
 ***********************/
async function makePDF(id){
    const r = getR(id);

    // Daten ins PDF-Layout übertragen
    $("p_firma").innerText = $("firma").value;
    $("p_adresse").innerText = $("adresse").value;
    $("p_email").innerText = $("email").value;
    $("p_telefon").innerText = $("telefon").value;

    $("p_rnr").innerText = r.rnr;
    $("p_kunde").innerText = r.kunde;
    $("p_datum").innerText = r.datum;
    $("p_summe").innerText = r.summe;

    const pos = $("p_pos");
    pos.innerHTML="";
    r.positionen.forEach(p=>{
        pos.innerHTML += `<tr><td>${p.desc}</td><td>${p.price}</td></tr>`;
    });

    const node = document.getElementById("pdfLayout");
    node.style.display="block";

    const canvas = await html2canvas(node, { scale:3 });
    const img = canvas.toDataURL("image/png");

    const pdf = new jspdf.jsPDF({
        orientation: "portrait",
        unit: "mm",
        format: "a4"
    });

    const pdfWidth = 210;
    const imgHeight = canvas.height * (pdfWidth / canvas.width);

    pdf.addImage(img, "PNG", 0, 0, pdfWidth, imgHeight);

    pdf.save(`Rechnung_${r.rnr}.pdf`);

    node.style.display="none";
}
</script>

</body>
</html>
